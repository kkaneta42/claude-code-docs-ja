name: Update Japanese Docs

on:
  schedule:
    - cron: '0 0 * * *'  # 毎日UTC 0時（日本時間9時）
  workflow_dispatch:      # 手動実行

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for updates
        run: ./docs-ja/scripts/check-updates.sh

      - name: Commit and push
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A

          # 変更がなければ終了
          if git diff --staged --quiet; then
            echo "No changes"
            exit 0
          fi

          # diffを取得
          DIFF=$(git diff --staged --stat)
          echo "=== DIFF ==="
          echo "$DIFF"

          # Geminiで要約生成
          REQUEST=$(jq -n --arg prompt "以下のgit diffの変更点を日本語で1-2行で簡潔に要約してください。技術的な内容は保持しつつ、分かりやすく。

$DIFF" '{contents:[{parts:[{text:$prompt}]}]}')

          echo "=== REQUEST ==="
          echo "$REQUEST"

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H 'Content-Type: application/json' \
            -d "$REQUEST")

          echo "=== RESPONSE ==="
          echo "$RESPONSE"

          SUMMARY=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text' | tr '\n' ' ' | head -c 200)

          echo "=== SUMMARY ==="
          echo "$SUMMARY"

          # 要約が取得できなければデフォルトメッセージ
          if [ -z "$SUMMARY" ] || [ "$SUMMARY" = "null" ]; then
            SUMMARY="ドキュメント更新"
          fi

          git commit -m "$SUMMARY"
          git push
