name: Update Japanese Docs

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for updates
        run: ./docs-ja/scripts/check-updates.sh

      - name: Generate update log
        run: TZ=Asia/Tokyo ./docs-ja/scripts/update-log.sh

      - name: Commit and push
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A

          if git diff --staged --quiet; then
            echo "No changes"
            exit 0
          fi

          DIFF=$(git diff --staged --stat)

          PROMPT="以下のgit diffの変更点を50文字以内の日本語で要約してください。ファイル名と主な変更内容を含めてください。変更点: ${DIFF}"

          REQUEST=$(jq -n --arg prompt "$PROMPT" '{contents:[{parts:[{text:$prompt}]}]}')

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H 'Content-Type: application/json' \
            -d "$REQUEST")

          SUMMARY=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text' | tr '\n' ' ' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

          if [ -z "$SUMMARY" ] || [ "$SUMMARY" = "null" ]; then
            SUMMARY="ドキュメント更新"
          fi

          git commit -m "$SUMMARY"
          git push
